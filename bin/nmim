#!/usr/bin/env bash

function throw() { echo -e "fatal: $1" > /dev/stderr; exit 1; }
function _usage() {
	echo
	echo "Usage: nmim <\$action> [...options]"
	echo
	echo "Actions:"
	echo
	echo "  start        mount node_modules into memory"
	echo "  save         save content in node_modules to node_modules.tar"
	echo "  stop         unmount node_modules from memory"
	echo "  status       get current node_modules status"
	echo "  stop-all     unmount all mounted node_modules directories"
	echo "  status-all   get all mounted node_modules status and status of node_modules in current directory"
	echo "  npm          mount node_modules into memory and execute npm command"
	echo
	echo "  help         (aliases: -h --help) print usage"
	echo
	exit 0
}

ACTION="$1";

__DIRNAME=`cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd`;
SRC_DIR="${__DIRNAME}/../src";
SCRIPT="";

[[ -z "$ACTION" ]] && _usage;

case "$ACTION" in
	npm)              SCRIPT="npm.sh" ;;
	go|start)         SCRIPT="start.sh" ;;
	save)             SCRIPT="save.sh" ;;
	stop)             SCRIPT="stop.sh" ;;
	stop-all)         SCRIPT="stop-all.sh" ;;
	status)           SCRIPT="status.sh" ;;
	status-all)       SCRIPT="status-all.sh" ;;

	-h|--help|help) _usage ;;

	*)  throw "unknwon action: \"$ACTION\"" ;;
esac

if [[ -n "$SCRIPT" ]]; then
	bash "$SRC_DIR/$SCRIPT" "${@:2}";
	exit $?;
fi
